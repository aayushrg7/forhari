#if 0
	shc Version 4.0.3, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -f cxfs.sh -o cxfs 
#endif

static  char data [] = 
#define      shll_z	10
#define      shll	((&data[1]))
	"\037\075\011\154\110\151\012\144\230\302\360"
#define      inlo_z	3
#define      inlo	((&data[11]))
	"\246\216\132"
#define      msg1_z	65
#define      msg1	((&data[28]))
	"\370\022\263\044\312\340\050\175\016\231\150\204\275\050\215\322"
	"\161\243\222\042\075\064\102\311\061\040\140\013\365\212\230\115"
	"\302\171\003\207\151\156\343\105\312\273\221\155\231\360\211\227"
	"\034\253\366\212\307\332\007\310\315\317\315\316\301\174\057\241"
	"\137\155\335\107\142\035\335\366\253\004\044\314\250\377\210\032"
	"\311\334\132\150\243\176\253\373\273\312\111"
#define      msg2_z	19
#define      msg2	((&data[108]))
	"\175\163\134\057\061\344\127\337\327\333\312\060\340\325\127\176"
	"\205\223\324\014\214\311\220"
#define      date_z	1
#define      date	((&data[128]))
	"\316"
#define      pswd_z	256
#define      pswd	((&data[171]))
	"\026\102\101\232\377\152\265\311\106\020\061\352\216\334\345\111"
	"\247\056\356\132\222\154\316\356\374\365\157\127\374\027\057\023"
	"\132\161\255\131\333\143\043\042\163\125\242\230\035\074\125\255"
	"\300\126\272\066\177\147\016\346\303\365\172\042\210\154\260\255"
	"\125\126\037\262\355\132\325\311\034\170\142\071\264\267\347\164"
	"\015\242\253\215\011\271\163\315\256\356\357\067\133\240\345\260"
	"\367\004\143\345\137\070\256\173\260\021\265\145\311\234\331\326"
	"\076\205\144\107\076\330\025\355\307\005\044\042\245\012\322\235"
	"\016\065\202\156\156\060\351\036\102\237\203\013\073\135\342\171"
	"\342\106\301\041\037\326\016\346\333\063\010\201\075\333\036\114"
	"\021\240\272\177\321\244\235\023\103\041\036\177\176\000\370\141"
	"\107\271\202\147\220\221\115\154\304\126\355\002\062\014\117\103"
	"\254\012\302\176\256\140\221\362\201\260\161\377\261\152\141\371"
	"\044\343\140\264\164\256\041\071\005\017\074\067\033\213\172\310"
	"\225\075\106\104\235\330\066\036\211\250\036\072\023\177\064\067"
	"\143\224\354\327\103\015\021\110\035\115\177\070\330\372\001\155"
	"\067\107\261\325\040\350\363\251\221\022\344\244\222\030\334\365"
	"\254\311\314\360\327\336\070\364\053\270\054\003\263\055\161\352"
	"\165\043\300\226\014\263\077\236\306\044\014\001\062\361\113\332"
	"\040\072\064\263\246\003\242\242\370\021\371\364\051\051\007\203"
	"\232\265\335\165\030\001\227\213\126\243\215\211\225\331\143\266"
	"\023\230\152\272\233\014\134\223\036\126\210\107\177\220\313\031"
#define      xecc_z	15
#define      xecc	((&data[483]))
	"\136\252\361\060\215\223\322\265\101\345\157\171\016\341\312\111"
	"\170\046\352"
#define      lsto_z	1
#define      lsto	((&data[500]))
	"\100"
#define      chk1_z	22
#define      chk1	((&data[503]))
	"\355\027\100\377\247\263\374\320\325\127\214\070\141\201\245\243"
	"\361\161\017\041\150\077\114\241\145"
#define      tst1_z	22
#define      tst1	((&data[529]))
	"\041\215\174\041\020\175\065\322\324\313\154\262\243\004\146\006"
	"\142\116\332\101\345\054\074\352\026"
#define      rlax_z	1
#define      rlax	((&data[551]))
	"\123"
#define      opts_z	1
#define      opts	((&data[552]))
	"\321"
#define      text_z	2408
#define      text	((&data[1002]))
	"\023\147\372\162\021\041\134\022\353\324\235\114\046\213\143\214"
	"\021\344\253\063\161\050\350\035\372\046\021\114\364\317\270\010"
	"\067\262\172\111\323\327\134\277\254\371\013\322\205\157\137\226"
	"\123\013\312\305\063\263\343\056\332\364\172\316\303\062\327\373"
	"\345\121\104\271\051\240\170\325\232\204\250\037\363\007\266\107"
	"\022\200\015\106\064\360\164\016\344\357\335\250\041\264\243\007"
	"\006\350\300\060\210\070\005\043\275\255\103\261\265\371\370\310"
	"\172\005\016\257\366\203\275\332\162\233\202\224\117\046\233\126"
	"\016\133\206\227\224\214\272\122\072\375\003\357\367\374\270\162"
	"\002\307\041\370\112\336\323\275\171\125\121\311\173\355\040\212"
	"\110\247\041\335\063\333\057\155\331\062\134\321\057\025\103\061"
	"\334\144\052\047\103\375\344\275\123\065\207\317\043\247\131\153"
	"\116\172\110\201\126\170\357\060\252\114\001\332\141\104\014\075"
	"\251\066\145\355\064\111\252\207\177\061\127\242\331\260\016\050"
	"\052\127\252\201\317\231\261\172\345\262\124\106\367\140\204\240"
	"\227\351\216\314\063\070\123\262\152\253\125\104\133\143\154\206"
	"\272\026\007\211\260\270\003\225\153\127\334\142\270\141\003\120"
	"\113\222\034\176\312\160\061\065\033\206\171\166\351\345\375\244"
	"\374\004\055\254\275\061\102\051\211\037\214\101\200\220\221\314"
	"\042\255\113\354\036\174\041\071\003\232\260\355\200\255\221\174"
	"\262\277\051\160\360\153\231\171\212\045\272\013\265\114\327\327"
	"\372\042\304\030\237\346\121\242\201\002\217\001\257\041\176\142"
	"\340\247\322\320\023\153\111\235\221\004\251\106\121\201\036\113"
	"\243\343\144\103\312\266\346\113\270\166\115\150\227\314\312\167"
	"\164\234\110\207\010\222\045\231\226\316\340\347\117\376\063\363"
	"\342\227\067\254\115\035\370\006\223\106\156\053\022\070\243\206"
	"\325\353\016\335\175\063\166\024\002\126\374\121\125\057\105\070"
	"\307\174\345\025\231\335\033\055\044\212\130\066\302\373\275\230"
	"\347\314\333\232\213\010\161\342\005\220\141\044\231\063\071\037"
	"\171\055\067\243\136\347\321\030\340\142\163\070\347\360\065\375"
	"\064\255\345\075\031\024\070\173\024\065\156\274\261\250\044\244"
	"\024\375\340\103\364\331\326\376\251\240\301\140\010\236\102\263"
	"\062\271\130\252\130\345\252\071\004\076\033\004\340\116\163\100"
	"\370\311\204\310\327\155\241\237\162\355\327\334\370\300\142\170"
	"\070\003\152\336\235\176\147\235\165\157\020\367\074\277\205\220"
	"\141\233\043\140\366\042\323\130\035\064\041\051\265\042\321\170"
	"\330\300\037\343\304\117\140\117\045\034\312\237\152\051\104\226"
	"\153\007\307\335\212\267\334\241\107\105\130\140\303\124\365\130"
	"\003\344\041\323\133\336\205\372\276\062\201\176\052\123\030\223"
	"\366\273\220\002\277\232\135\225\022\220\133\202\212\006\000\163"
	"\157\133\316\326\072\272\012\155\355\257\356\352\216\003\223\247"
	"\204\054\064\305\044\327\330\112\006\203\315\214\061\206\304\215"
	"\071\127\166\210\256\011\247\257\241\042\115\033\000\305\347\060"
	"\134\144\156\147\144\243\110\247\242\373\153\154\053\131\216\065"
	"\241\316\261\146\075\062\033\256\022\343\306\147\203\266\225\162"
	"\031\224\222\037\111\075\306\202\220\175\227\014\266\056\225\173"
	"\120\060\300\257\235\335\134\176\242\021\364\176\022\073\151\142"
	"\260\226\376\272\042\342\051\307\250\305\012\064\247\367\214\023"
	"\113\247\340\031\027\003\260\364\241\345\370\204\146\360\027\117"
	"\224\164\151\021\141\160\364\055\022\042\173\014\271\150\317\017"
	"\164\276\260\310\201\141\103\064\304\316\030\375\163\162\015\347"
	"\056\027\362\270\117\344\221\077\160\164\216\040\353\064\314\027"
	"\214\107\225\240\116\301\107\313\060\337\046\264\013\233\020\110"
	"\266\256\002\234\254\043\067\025\332\322\117\251\100\341\326\237"
	"\241\363\304\312\067\327\026\030\246\203\313\320\044\377\017\233"
	"\346\216\050\352\146\061\342\125\051\310\227\240\347\004\373\350"
	"\020\157\112\260\162\027\357\220\353\337\257\376\311\015\303\065"
	"\153\235\305\321\311\362\306\064\333\066\225\163\004\205\145\032"
	"\052\250\021\374\304\103\360\360\064\007\157\370\214\162\351\055"
	"\106\331\333\011\350\326\034\323\350\335\165\131\041\135\104\317"
	"\270\123\162\333\117\105\077\255\275\270\172\210\266\111\027\361"
	"\346\164\166\305\366\135\332\160\157\223\372\316\107\027\137\123"
	"\144\032\236\220\354\165\272\170\130\311\012\275\010\255\277\134"
	"\136\153\121\163\277\067\136\242\347\325\334\151\303\016\302\235"
	"\072\006\261\124\046\021\340\133\075\270\365\273\131\226\026\077"
	"\236\172\053\237\247\040\202\173\260\074\351\262\314\133\067\151"
	"\272\170\313\116\234\015\201\075\364\374\241\040\140\214\335\236"
	"\366\303\156\131\140\133\327\337\346\126\371\303\247\121\316\144"
	"\176\357\300\077\041\202\042\045\247\370\227\355\357\112\175\202"
	"\112\023\002\075\070\320\366\323\132\047\050\070\226\257\237\363"
	"\007\253\152\071\153\270\222\042\264\020\337\350\216\072\142\205"
	"\075\334\246\116\346\202\170\352\013\026\000\024\250\346\055\325"
	"\247\250\360\323\305\202\037\113\367\337\062\350\335\145\060\143"
	"\145\221\137\131\161\342\366\112\147\115\043\223\316\043\063\221"
	"\032\221\130\056\040\004\054\252\024\011\043\204\060\355\241\033"
	"\075\260\246\302\102\126\354\137\347\370\267\070\047\031\076\231"
	"\203\233\034\267\320\065\335\371\031\264\166\071\212\135\276\247"
	"\203\276\301\237\275\042\123\075\027\030\305\024\207\137\237\353"
	"\103\053\255\051\027\007\045\271\115\205\054\326\200\167\211\005"
	"\173\157\222\252\160\260\350\333\306\062\105\261\145\207\101\252"
	"\140\103\321\031\051\174\112\106\105\215\146\351\246\141\140\004"
	"\223\047\131\061\243\312\046\127\335\302\307\106\117\150\375\214"
	"\034\201\160\340\154\167\115\173\253\072\332\263\133\123\326\212"
	"\146\035\124\035\214\275\106\271\360\104\162\342\325\305\337\042"
	"\062\204\141\276\335\021\326\145\276\206\365\344\325\015\343\176"
	"\222\303\011\023\033\301\337\373\332\222\360\121\006\216\046\140"
	"\251\137\205\375\266\207\274\371\057\144\162\027\017\154\377\211"
	"\140\064\167\067\373\021\341\353\247\320\006\052\056\260\070\264"
	"\067\334\204\131\170\004\035\317\014\105\157\332\332\342\056\147"
	"\120\265\154\103\136\216\037\001\226\066\162\036\101\216\032\242"
	"\245\102\336\020\160\366\066\000\125\230\361\064\225\217\000\304"
	"\104\154\264\233\076\143\245\156\027\002\344\245\302\061\166\367"
	"\224\072\221\210\132\122\347\233\221\321\234\204\102\015\266\333"
	"\240\057\143\050\354\303\250\330\225\301\175\205\230\062\127\016"
	"\072\242\170\000\313\042\000\364\363\044\370\273\327\234\175\132"
	"\136\126\161\301\154\057\224\033\365\143\072\016\056\113\065\312"
	"\330\077\103\112\214\367\303\212\273\234\232\202\245\021\375\072"
	"\060\156\005\202\371\074\115\053\260\002\350\132\266\063\253\061"
	"\153\162\326\003\204\362\220\110\142\237\055\032\364\012\163\072"
	"\374\170\164\140\026\026\242\123\226\357\012\257\337\010\312\013"
	"\335\346\035\327\256\240\371\003\077\312\104\061\047\316\070\326"
	"\253\365\270\103\024\375\252\051\205\302\260\116\300\062\301\273"
	"\150\171\351\200\137\017\220\273\372\216\150\363\330\246\077\064"
	"\034\055\253\212\203\374\113\026\273\332\126\152\264\014\006\316"
	"\000\115\243\375\051\150\115\274\007\011\205\272\363\173\146\242"
	"\104\213\357\147\107\321\362\064\172\171\253\321\207\264\351\162"
	"\011\112\177\311\205\163\217\237\275\220\274\202\244\264\160\363"
	"\026\151\336\210\322\043\124\153\271\001\337\265\353\233\314\101"
	"\127\341\351\015\002\152\165\000\372\167\112\275\353\236\355\114"
	"\107\164\074\061\175\051\315\326\046\314\343\233\201\106\203\262"
	"\353\161\072\144\030\060\240\352\315\254\376\365\103\024\010\241"
	"\123\345\374\161\101\056\247\114\022\230\333\210\347\234\256\166"
	"\170\245\302\253\230\135\214\156\016\067\022\164\303\217\354\134"
	"\377\126\331\327\173\263\217\204\160\245\365\257\275\234\133\316"
	"\301\023\235\333\256\234\136\370\371\322\237\120\210\044\125\002"
	"\254\357\202\150\120\057\026\017\016\030\147\035\316\331\147\107"
	"\212\304\127\172\235\375\011\261\066\134\144\170\060\051\054\130"
	"\177\274\134\000\072\146\140\113\264\177\273\203\157\313\350\031"
	"\070\330\303\266\276\371\317\010\157\324\171\305\161\053\125\265"
	"\045\203\302\301\077\035\154\046\127\031\125\301\333\236\341\331"
	"\236\223\250\301\277\155\153\143\302\373\032\121\265\127\244\254"
	"\106\232\254\264\211\376\233\031\265\057\117\031\002\244\322\054"
	"\223\332\126\250\216\243\157\317\203\134\052\200\341\150\062\052"
	"\312\067\003\255\267\100\301\360\077\303\102\060\334\332\125\121"
	"\274\303\134\226\023\367\320\377\352\321\205\110\157\064\345\121"
	"\227\314\002\240\046\365\321\212\123\227\014\252\334\264\240\041"
	"\216\013\277\212\245\031\057\005\000\264\030\004\224\065\220\214"
	"\016\256\230\344\326\216\311\377\275\144\325\257\130\337\227\165"
	"\277\123\252\305\070\277\015\374\310\261\276\373\072\064\361\101"
	"\157\366\330\332\311\255\317\035\174\015\102\376\331\054\241\234"
	"\377\257\064\265\326\261\071\145\332\043\315\224\000\152\276\176"
	"\372\036\074\276\156\223\257\350\165\152\301\363\154\147\116\376"
	"\201\002\171\356\112\315\130\372\203\127\132\174\333\361\061\054"
	"\266\174\245\015\233\235\335\015\351\341\172\021\076\131\106\343"
	"\220\122\255\055\364\142\126\043\125\224\350\113\337\205\322\114"
	"\047\121\225\354\315\033\134\366\343\372\104\060\344\121\333\253"
	"\256\353\122\233\114\061\215\022\302\043\325\000\347\233\201\346"
	"\005\012\065\246\367\257\265\147\272\377\132\013\272\015\333\106"
	"\265\053\111\045\113\372\204\054\054\377\354\247\350\301\222\046"
	"\041\102\045\371\327\054\215\161\040\262\321\245\344\235\114\342"
	"\244\014\066\171\073\143\263\024\272\272\136\133\273\327\367\244"
	"\272\005\267\116\151\375\064\142\220\127\011\044\113\233\052\052"
	"\374\022\050\336\363\000\256\012\355\007\274\371\076\135\312\107"
	"\354\112\265\237\331\373\026\062\367\310\147\222\252\341\234\147"
	"\254\053\050\157\172\331\032\072\353\304\246\302\334\150\113\150"
	"\011\275\162\274\137\166\317\330\064\277\250\207\370\323\037\305"
	"\136\274\260\012\212\172\151\253\116\043\372\114\376\253\045\217"
	"\351\310\130\167\162\113\135\271\025\347\164\102\126\235\000\301"
	"\051\260\132\260\123\240\003\301\016\157\337\037\231\150\207\306"
	"\376\156\345\004\034\174\323\315\361\351\026\144\243\044\104\250"
	"\304\215\227\302\146\262\336\272\042\215\220\033\025\373\135\200"
	"\137\306\131\276\010\052\240\035\253\003\256\311\351\203\206\356"
	"\161\200\060\022\257\110\312\023\004\056\035\004\342\354\055\143"
	"\134\254\035\112\246\075\041\073\357\007\176\230\070\064\025\251"
	"\215\334\275\377\274\277\270\257\217\076\254\161\253\076\161\152"
	"\230\250\167\246\044\045\153\331\072\154\060\210\034\114\130\003"
	"\077\241\005\247\013\060\314\047\232\307\155\170\252\300\214\344"
	"\353\273\220\322\064\030\243\321\310\347\077\255\340\305\134\313"
	"\222\043\320\227\203\376\014\360\274\315\364\276\207\165\223\240"
	"\363\151\055\343\023\243\314\353\314\237\215\012\363\032\103\117"
	"\111\372\106\033\031\065\350\062\064\034\134\011\325\211\207\034"
	"\020\046\300\377\041\011\322\114\312\321\157\337\170\165\315\012"
	"\322\322\256\263\155\132\037\261\203\140\326\017\217\113\133\001"
	"\135\205\332\056\321\130\264\065\167\043\063\360\337\366\170\161"
	"\227\207\215\267\113\072\247\345\232\274\061\076\111\220\215\264"
	"\166\264\062\037\110\334\374\042\337\372\203\366\011\034\143\213"
	"\245\176\273\274\052\167\174\164\337\165\373\272\114\376\005\062"
	"\243\171\233\057\117\362\302\324\150\100\101\335\346\136\202\254"
	"\210\231\201\077\331\164\042\311\036\371\347\273\001\022\226\237"
	"\140\307\233\253\005\164\327\365\345\151\205\020\154\366\352\102"
	"\226\072\372\157\355\101\255\040\323\023\002\277\331\177\325\222"
	"\020\075\263\062\325\240\166\137\002\134\176\202\365\255\110\157"
	"\215\167\353\250\024\122\166\210\024\245\202\272\122\364\024\243"
	"\032\377\237\022\140\221\011\002\161\274\302\350\374\362\164\105"
	"\241\045\254\157\003\302\354\175\030\160\377\031\257\115\024\164"
	"\204\120\010\036\102\132\117\004\017\174\232\164\212\376\320\005"
	"\323\303\240\211\222\060\153\243\344\363\327\261\123\271\325\303"
	"\227\356\110\075\376\227\136\221\366\125\102\172\101\357\202\234"
	"\167\122\025\036\162\367\253\141\327\313\166\144\377\354\171\001"
	"\103\165\123\231\245\230\322\154\025\267\201\256\225\235\334\271"
	"\047\064\360\352\060\255\202\027\171\370\174\170\345\365\172\051"
	"\152\315\302\020\146\225\174\173\114\376\052\341\233\006\233\302"
	"\073\213\254\153\071\057\202\263\047\376\053\015\364\246\066\137"
	"\164\371\157\332\216\353\126\332\352\200\274\205\207\130\110\303"
	"\343\365\056\035\044\261\320\114\260\374\131\244\242\217\003\026"
	"\210\163\361\027\136\107\362\110\310\257\316\117\007\026\022\353"
	"\013\101\010\060\363\330\174\244\324\325\111\167\145\115\215\356"
	"\300\177\005\037\306\370\147\216\247\066\336\256\115\361\232\130"
	"\063\242\211\046\173\005\313\120\333\024\307\101\141\125\060\042"
	"\324\066\101\233\056\251\051\325\337\007\204\054\370\037\205\053"
	"\301\016\122\075\024\035\215\360\062\125\062\224\253\142\266\200"
	"\230\367\033\306\240\104\234\177\114\041\254\105\100\061\161\002"
	"\100\303\077\125\341\315\105\023\043\167\247\316\332\135\116\162"
	"\125\151\071\365\256\325\165\373\367\041\100\070\123\261\072\223"
	"\165\172\351\126\110\056"
#define      tst2_z	19
#define      tst2	((&data[3665]))
	"\021\072\051\160\333\356\275\340\155\276\267\216\110\153\167\241"
	"\007\353\207\100\205\200\157\210"
#define      chk2_z	19
#define      chk2	((&data[3690]))
	"\054\273\241\302\144\076\062\366\007\256\375\007\370\272\300\202"
	"\371\374\213\031\051\266\001\060\234\371"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

#if HARDENING
static const char * shc_x[] = {
"/*",
" * Copyright 2019 - Intika <intika@librefox.org>",
" * Replace ******** with secret read from fd 21",
" * Also change arguments location of sub commands (sh script commands)",
" * gcc -Wall -fpic -shared -o shc_secret.so shc_secret.c -ldl",
" */",
"",
"#define _GNU_SOURCE /* needed to get RTLD_NEXT defined in dlfcn.h */",
"#define PLACEHOLDER \"********\"",
"#include <dlfcn.h>",
"#include <stdlib.h>",
"#include <string.h>",
"#include <unistd.h>",
"#include <stdio.h>",
"#include <signal.h>",
"",
"static char secret[128000]; //max size",
"typedef int (*pfi)(int, char **, char **);",
"static pfi real_main;",
"",
"// copy argv to new location",
"char **copyargs(int argc, char** argv){",
"    char **newargv = malloc((argc+1)*sizeof(*argv));",
"    char *from,*to;",
"    int i,len;",
"",
"    for(i = 0; i<argc; i++){",
"        from = argv[i];",
"        len = strlen(from)+1;",
"        to = malloc(len);",
"        memcpy(to,from,len);",
"        // zap old argv space",
"        memset(from,'\\0',len);",
"        newargv[i] = to;",
"        argv[i] = 0;",
"    }",
"    newargv[argc] = 0;",
"    return newargv;",
"}",
"",
"static int mymain(int argc, char** argv, char** env) {",
"    //fprintf(stderr, \"Inject main argc = %d\\n\", argc);",
"    return real_main(argc, copyargs(argc,argv), env);",
"}",
"",
"int __libc_start_main(int (*main) (int, char**, char**),",
"                      int argc,",
"                      char **argv,",
"                      void (*init) (void),",
"                      void (*fini)(void),",
"                      void (*rtld_fini)(void),",
"                      void (*stack_end)){",
"    static int (*real___libc_start_main)() = NULL;",
"    int n;",
"",
"    if (!real___libc_start_main) {",
"        real___libc_start_main = dlsym(RTLD_NEXT, \"__libc_start_main\");",
"        if (!real___libc_start_main) abort();",
"    }",
"",
"    n = read(21, secret, sizeof(secret));",
"    if (n > 0) {",
"      int i;",
"",
"    if (secret[n - 1] == '\\n') secret[--n] = '\\0';",
"    for (i = 1; i < argc; i++)",
"        if (strcmp(argv[i], PLACEHOLDER) == 0)",
"          argv[i] = secret;",
"    }",
"",
"    real_main = main;",
"",
"    return real___libc_start_main(mymain, argc, argv, init, fini, rtld_fini, stack_end);",
"}",
"",
0};
#endif /* HARDENING */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a process */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void shc_x_file() {
    FILE *fp;
    int line = 0;

    if ((fp = fopen("/tmp/shc_x.c", "w")) == NULL ) {exit(1); exit(1);}
    for (line = 0; shc_x[line]; line++)	fprintf(fp, "%s\n", shc_x[line]);
    fflush(fp);fclose(fp);
}

int make() {
	char * cc, * cflags, * ldflags;
    char cmd[4096];

	cc = getenv("CC");
	if (!cc) cc = "cc";

	sprintf(cmd, "%s %s -o %s %s", cc, "-Wall -fpic -shared", "/tmp/shc_x.so", "/tmp/shc_x.c -ldl");
	if (system(cmd)) {remove("/tmp/shc_x.c"); return -1;}
	remove("/tmp/shc_x.c"); return 0;
}

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    char tmp3[len+1024];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;
    int lentmp = len;
    int pid, status;
    pid = fork();

    shc_x_file();
    if (make()) {exit(1);}

    setenv("LD_PRELOAD","/tmp/shc_x.so",1);

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Do the magic
        sprintf(tmp3, "%s %s", "'********' 21<<<", tmp2);

        //Exec bash script //fork execl with 'sh -c'
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Clean temp
        remove("/tmp/shc_x.so");

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {wait(&status);}

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
}
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
